from unittest import TestCase

import numpy as np

from gcaa.core.dta import optimal_control_dta


class TestDTA(TestCase):
    def setUp(self):
        np.random.seed(0)

    def test(self):
        results = optimal_control_dta(
            n_rounds=20,
            na=5,
            nt=4,
            uniform_agents=False,
            uniform_tasks=True,
            limited_communication=True,
            plot_range=True,
        )
        print(results)
        expected = np.array(
            [[[0.53519874, 0.70020441],
              [0.54403814, 0.54989865],
              [0.40325917, 0.66118218],
              [0.4522546, 0.80488459],
              [0.84738577, 0.43417658]],

             [[0.52638376, 0.71511002],
              [0.50650956, 0.56454517],
              [0.36988619, 0.6989964],
              [0.45556796, 0.79846343],
              [0.82648697, 0.45786072]],

             [[0.51313587, 0.71806042],
              [0.46977042, 0.57970152],
              [0.33876762, 0.73059346],
              [0.45988206, 0.79398566],
              [0.80809308, 0.47803694]],

             [[0.49598834, 0.71025506],
              [0.43396712, 0.59522221],
              [0.32129566, 0.75191189],
              [0.46506836, 0.79128099],
              [0.79206252, 0.49493798]],

             [[0.47547815, 0.69290167],
              [0.39924703, 0.61096075],
              [0.31612739, 0.76390674],
              [0.4709974, 0.79017793],
              [0.77825272, 0.50879821]],

             [[0.45214646, 0.66721745],
              [0.36575871, 0.62676951],
              [0.32190941, 0.76754047],
              [0.47753873, 0.79050368],
              [0.76652, 0.5198538]],

             [[0.42653923, 0.63443041],
              [0.33365201, 0.64249954],
              [0.3372763, 0.76378411],
              [0.48456073, 0.79208388],
              [0.7567194, 0.52834303]],

             [[0.39920803, 0.59578107],
              [0.30307833, 0.65800037],
              [0.36084869, 0.75361862],
              [0.49193042, 0.7947424],
              [0.74870448, 0.53450664]],

             [[0.3707109, 0.55252465],
              [0.27419085, 0.67311974],
              [0.38487783, 0.7493038],
              [0.49951329, 0.79830102],
              [0.74232708, 0.53858817]],

             [[0.34161369, 0.50593381],
              [0.24714487, 0.68770331],
              [0.40896339, 0.75004637],
              [0.50717292, 0.80257905],
              [0.73743695, 0.54083458]],

             [[0.31249156, 0.45730222],
              [0.22209829, 0.70159414],
              [0.43269838, 0.75503992],
              [0.51477065, 0.80739283],
              [0.7338814, 0.54149689]],

             [[0.28393119, 0.40794944],
              [0.19921213, 0.7146322],
              [0.45566772, 0.7634619],
              [0.52216505, 0.81255499],
              [0.73150466, 0.54083116]],

             [[0.25653375, 0.35922762],
              [0.17865141, 0.72665347],
              [0.47744603, 0.77446947],
              [0.5292112, 0.81787356],
              [0.7301471, 0.53909976]],

             [[0.23091918, 0.31253115],
              [0.16058629, 0.73748883],
              [0.49759468, 0.78719346],
              [0.53575964, 0.82315056],
              [0.72964414, 0.53657326]],

             [[0.20773274, 0.26931133],
              [0.14519389, 0.74696223],
              [0.51565712, 0.80072918],
              [0.54165483, 0.82817994],
              [0.72982446, 0.53353327]],

             [[0.18765554, 0.23110011],
              [0.13266116, 0.75488788],
              [0.53115143, 0.81412174],
              [0.54673256, 0.83274419],
              [0.73050721, 0.53027705]],

             [[0.17142317, 0.19955197],
              [0.12319001, 0.76106508],
              [0.54355713, 0.8263398],
              [0.5508155, 0.83660841],
              [0.7314971, 0.52712565]],

             [[0.15986316, 0.17652822],
              [0.1170076, 0.76526808],
              [0.55228872, 0.83622314],
              [0.55370416, 0.83950833],
              [0.73257441, 0.52444023]],

             [[0.15398695, 0.16430378],
              [0.11439154, 0.76722094],
              [0.55663053, 0.8423537],
              [0.55515471, 0.84112096],
              [0.73347059, 0.52266223]],

             [[0.15531169, 0.16629105],
              [0.11575828, 0.76650978],
              [0.55550911, 0.8426044],
              [0.55480139, 0.8409618],
              [0.73378284, 0.52245379]]]
        )

        np.testing.assert_allclose(results['historical_path'], expected)
